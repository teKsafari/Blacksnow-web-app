<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Black Snow Smart House</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Inter:wght@400;500;600;700&display=swap');

    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.1);
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.4);
    }

    *,
    *::before,
    *::after {
      box-sizing: border-box;
    }

    body,
    html {
      margin: 0;
      padding: 0;
      font-family: 'Share Tech Mono', monospace;
      background: radial-gradient(circle at 10% 20%, rgb(20, 30, 48) 0%, rgb(12, 20, 40) 90%);
      color: #e0e0e0;
      height: 100%;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      top: -20%;
      left: -10%;
      width: 50vw;
      height: 50vw;
      background: radial-gradient(circle, rgba(0, 255, 255, 0.12), transparent 65%);
      z-index: 0;
      pointer-events: none;
      filter: blur(60px);
    }

    body::after {
      content: '';
      position: fixed;
      bottom: -15%;
      right: -5%;
      width: 40vw;
      height: 40vw;
      background: radial-gradient(circle, rgba(70, 0, 255, 0.1), transparent 65%);
      z-index: 0;
      pointer-events: none;
      filter: blur(70px);
    }

    /* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
    .container {
      flex: 1;
      display: flex;
      flex-direction: row;
      overflow: hidden;
      padding: 16px;
      gap: 16px;
      z-index: 2;
      position: relative;
    }

    #left {
      width: 440px;
      background: rgba(255, 255, 255, 0.04);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.09);
      border-radius: 18px;
      padding: 24px 20px;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      box-shadow: 0 8px 40px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.06);
    }

    /* ‚îÄ‚îÄ HEADER BAR ‚îÄ‚îÄ */
    #header-bar {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 16px;
    }

    #header-bar .logo-icon {
      width: 34px;
      height: 34px;
      background: linear-gradient(135deg, #00c6ff, #0072ff);
      border-radius: 9px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      box-shadow: 0 0 14px rgba(0, 198, 255, 0.35);
      flex-shrink: 0;
    }

    #header-bar .logo-text {
      font-family: 'Inter', sans-serif;
      font-size: 1em;
      font-weight: 700;
      color: #fff;
      letter-spacing: 0.5px;
      line-height: 1.2;
    }

    #header-bar .logo-text span {
      color: #0ff;
      font-weight: 400;
      font-size: 0.8em;
      display: block;
      opacity: 0.7;
    }

    /* ‚îÄ‚îÄ MODE SWITCHER ‚îÄ‚îÄ */
    .mode-switcher {
      display: flex;
      gap: 0;
      background: rgba(0, 0, 0, 0.35);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 10px;
      padding: 3px;
      margin-bottom: 18px;
      position: relative;
    }

    .mode-btn {
      flex: 1;
      padding: 8px 0;
      border: none;
      border-radius: 7px;
      cursor: pointer;
      font-family: 'Inter', sans-serif;
      font-size: 0.82em;
      font-weight: 600;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      transition: all 0.25s ease;
      position: relative;
      z-index: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      background: transparent;
      color: rgba(255, 255, 255, 0.45);
    }

    .mode-btn svg {
      opacity: 0.6;
      transition: opacity 0.2s;
    }

    .mode-btn.active {
      background: linear-gradient(135deg, rgba(0, 198, 255, 0.2), rgba(0, 114, 255, 0.25));
      color: #fff;
      box-shadow: 0 2px 12px rgba(0, 114, 255, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(0, 198, 255, 0.25);
    }

    .mode-btn.active svg {
      opacity: 1;
    }

    .mode-btn:hover:not(.active) {
      color: rgba(255, 255, 255, 0.7);
      background: rgba(255, 255, 255, 0.05);
    }

    /* ‚îÄ‚îÄ SECTION HEADERS ‚îÄ‚îÄ */
    #left h3 {
      text-align: left;
      font-size: 0.78em;
      margin: 14px 0 8px 0;
      color: rgba(0, 255, 255, 0.7);
      text-transform: uppercase;
      letter-spacing: 2px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.07);
      padding-bottom: 5px;
      font-family: 'Inter', sans-serif;
      font-weight: 600;
    }

    #left h3:first-child {
      margin-top: 0;
    }

    /* ‚îÄ‚îÄ SETUP ROW ‚îÄ‚îÄ */
    #houseIdInput {
      flex: 1;
      padding: 9px 12px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      outline: none;
      background: rgba(0, 0, 0, 0.35);
      color: #fff;
      font-family: inherit;
      transition: 0.3s;
      font-size: 0.9em;
    }

    #houseIdInput:focus {
      border-color: #0ff;
      background: rgba(0, 0, 0, 0.55);
      box-shadow: 0 0 12px rgba(0, 255, 255, 0.18);
    }

    #houseIdInput::placeholder {
      color: rgba(255, 255, 255, 0.3);
    }

    .setup-row {
      display: flex;
      gap: 8px;
      margin-bottom: 14px;
    }

    .setup-row button {
      width: auto;
      padding: 9px 13px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.06);
      color: #fff;
      cursor: pointer;
      transition: 0.2s;
      font-family: inherit;
      font-size: 0.85em;
      white-space: nowrap;
    }

    .setup-row button:hover {
      background: rgba(255, 255, 255, 0.14);
      border-color: rgba(255, 255, 255, 0.25);
    }

    #pasteBtn {
      padding: 9px 12px;
      display: flex;
      align-items: center;
    }

    /* ‚îÄ‚îÄ BLOCK ACTIONS ‚îÄ‚îÄ */
    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-bottom: 12px;
    }

    .actions button {
      padding: 5px 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      background: rgba(255, 255, 255, 0.05);
      color: rgba(255, 255, 255, 0.7);
      cursor: pointer;
      transition: all 0.18s;
      font-family: 'Inter', sans-serif;
      font-size: 0.78em;
      font-weight: 500;
      letter-spacing: 0.4px;
      white-space: nowrap;
    }

    .actions button:hover {
      background: rgba(0, 255, 255, 0.12);
      border-color: rgba(0, 255, 255, 0.45);
      color: #0ff;
      box-shadow: 0 0 10px rgba(0, 255, 255, 0.12);
    }

    .actions button:active {
      transform: scale(0.96);
    }

    /* ‚îÄ‚îÄ WORKSPACE ‚îÄ‚îÄ */
    .workspace {
      flex: 1;
      background: rgba(0, 0, 0, 0.22);
      border-radius: 10px;
      padding: 10px;
      overflow: auto;
      display: flex;
      flex-direction: column;
      gap: 7px;
      border: 1px solid rgba(255, 255, 255, 0.05);
      box-shadow: inset 0 0 18px rgba(0, 0, 0, 0.5);
      min-height: 120px;
    }

    .workspace-empty {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      color: rgba(255, 255, 255, 0.18);
      font-size: 0.82em;
      letter-spacing: 1px;
      text-align: center;
      pointer-events: none;
      font-family: 'Inter', sans-serif;
    }

    .block {
      background: rgba(255, 255, 255, 0.07);
      backdrop-filter: blur(4px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-left: 3px solid #0ff;
      border-radius: 8px;
      padding: 9px 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 7px;
      align-items: center;
      cursor: grab;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
      transition: all 0.2s;
      position: relative;
    }

    .block:hover {
      background: rgba(255, 255, 255, 0.13);
      transform: translateY(-2px);
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.45);
    }

    .block.drag-over {
      border-color: #0ff;
      background: rgba(0, 255, 255, 0.08);
    }

    .block strong {
      color: #0ff;
      margin-right: 3px;
      font-size: 0.88em;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .block select,
    .block input[type=range],
    .block input[type=number] {
      border-radius: 5px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      padding: 3px 7px;
      background: rgba(0, 0, 0, 0.45);
      color: #fff;
      font-family: inherit;
      outline: none;
      font-size: 0.85em;
    }

    .block input[type=range] {
      -webkit-appearance: none;
      width: 95px;
      background: transparent;
    }

    .block input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      background: #0ff;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      cursor: pointer;
      margin-top: -4px;
      box-shadow: 0 0 5px #0ff;
    }

    .block input[type=range]::-webkit-slider-runnable-track {
      background: rgba(255, 255, 255, 0.2);
      height: 4px;
      border-radius: 2px;
    }

    .block .block-del {
      margin-left: auto;
      background: transparent;
      border: 1px solid rgba(255, 60, 60, 0.35);
      color: #ff5555;
      border-radius: 4px;
      padding: 2px 8px;
      cursor: pointer;
      font-size: 0.8em;
      transition: 0.15s;
    }

    .block .block-del:hover {
      background: rgba(255, 0, 0, 0.2);
      border-color: #ff5555;
    }

    .ws-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 14px 0 8px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.07);
      padding-bottom: 5px;
    }

    .ws-header h3 {
      margin: 0;
      border: none;
      padding: 0;
    }

    /* Right-side convert button */
    #convertBtn {
      padding: 5px 11px;
      border-radius: 6px;
      border: 1px solid rgba(0, 255, 255, 0.25);
      background: rgba(0, 255, 255, 0.07);
      color: #0ff;
      font-family: inherit;
      font-size: 0.75em;
      cursor: pointer;
      transition: 0.2s;
      letter-spacing: 0.5px;
    }

    #convertBtn:hover {
      background: rgba(0, 255, 255, 0.18);
    }

    /* ‚îÄ‚îÄ RUN BUTTON ‚îÄ‚îÄ */
    .run-btn {
      padding: 9px 18px;
      border: none;
      border-radius: 8px;
      background: linear-gradient(90deg, #00c6ff 0%, #0072ff 100%);
      color: #fff;
      font-weight: 700;
      font-size: 0.88em;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      box-shadow: 0 0 14px rgba(0, 114, 255, 0.4);
      transition: all 0.25s;
      font-family: 'Inter', sans-serif;
      display: flex;
      align-items: center;
      gap: 7px;
    }

    .run-btn:hover {
      box-shadow: 0 0 22px rgba(0, 114, 255, 0.65);
      transform: translateY(-1px);
    }

    .run-btn:active {
      transform: translateY(0);
      box-shadow: 0 0 10px rgba(0, 114, 255, 0.4);
    }

    /* ‚îÄ‚îÄ OUTPUT TERMINAL ‚îÄ‚îÄ */
    .output-panel {
      margin-top: 14px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      overflow: hidden;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      background: rgba(0, 0, 0, 0.5);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.04);
    }

    .output-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 12px;
      background: rgba(255, 255, 255, 0.04);
      border-bottom: 1px solid rgba(255, 255, 255, 0.07);
      flex-shrink: 0;
    }

    .output-header-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .output-dots {
      display: flex;
      gap: 5px;
    }

    .output-dot {
      width: 9px;
      height: 9px;
      border-radius: 50%;
    }

    .output-dot.red {
      background: rgba(255, 95, 87, 0.7);
    }

    .output-dot.yellow {
      background: rgba(255, 189, 46, 0.7);
    }

    .output-dot.green {
      background: rgba(40, 201, 64, 0.7);
    }

    .output-title {
      font-family: 'Inter', sans-serif;
      font-size: 0.7em;
      font-weight: 600;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: rgba(255, 255, 255, 0.3);
    }

    .output-clear-btn {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      color: rgba(255, 255, 255, 0.3);
      font-family: 'Inter', sans-serif;
      font-size: 0.68em;
      font-weight: 500;
      letter-spacing: 0.5px;
      padding: 2px 8px;
      cursor: pointer;
      transition: all 0.15s;
      text-transform: uppercase;
    }

    .output-clear-btn:hover {
      border-color: rgba(255, 255, 255, 0.25);
      color: rgba(255, 255, 255, 0.6);
    }

    #log {
      background: transparent;
      color: rgba(180, 255, 180, 0.85);
      font-size: 11.5px;
      padding: 7px 14px;
      height: 58px;
      overflow-y: auto;
      font-family: 'Share Tech Mono', monospace;
      line-height: 1.7;
      flex-shrink: 0;
    }

    .log-line {
      display: flex;
      gap: 10px;
      align-items: baseline;
    }

    .log-ts {
      color: rgba(255, 255, 255, 0.2);
      font-size: 0.85em;
      flex-shrink: 0;
      user-select: none;
    }

    .log-line .log-err {
      color: #ff6b6b;
    }

    .log-line .log-ok {
      color: #5dfc82;
    }

    .log-line .log-info {
      color: #4dd8ff;
    }

    /* ‚îÄ‚îÄ MODE PANELS ‚îÄ‚îÄ */
    #blocksMode,
    #codeMode {
      display: flex;
      flex-direction: column;
      flex: 1;
      min-height: 0;
    }

    .hidden {
      display: none !important;
    }

    /* ‚îÄ‚îÄ CODE MODE ‚îÄ‚îÄ */
    #codePanel {
      display: flex;
      flex-direction: column;
      flex: 1;
      min-height: 0;
    }

    #monacoContainer {
      flex: 1;
      min-height: 0;
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: inset 0 0 14px rgba(0, 0, 0, 0.6);
    }

    .code-run-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 12px;
    }



    /* API pill badges */
    .api-pills {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-bottom: 10px;
    }

    .api-pill {
      padding: 3px 9px;
      border-radius: 20px;
      background: rgba(0, 255, 255, 0.08);
      border: 1px solid rgba(0, 255, 255, 0.2);
      color: #0ff;
      font-size: 0.72em;
      font-family: 'Share Tech Mono', monospace;
      letter-spacing: 0.3px;
      cursor: default;
      transition: background 0.2s;
    }

    .api-pill:hover {
      background: rgba(0, 255, 255, 0.16);
    }

    /* ‚îÄ‚îÄ RIGHT PANEL (iframe sim) ‚îÄ‚îÄ */
    #right {
      flex: 1;
      background: rgba(255, 255, 255, 0.02);
      backdrop-filter: blur(10px);
      border-radius: 18px;
      overflow: hidden;
      box-shadow: 0 8px 40px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.06);
      z-index: 1;
    }

    #right iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    /* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
    @media(max-width: 960px) {
      .container {
        flex-direction: column;
        padding: 0;
        gap: 0;
        height: 100%;
      }

      #left {
        width: 100%;
        height: 55%;
        margin: 0;
        border-radius: 0;
        border: none;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      #right {
        flex: none;
        width: 100%;
        height: 45%;
        border-radius: 0;
        overflow-y: auto;
      }

      body,
      html {
        overflow: hidden;
        height: 100%;
      }

      #setBtn {
        display: none;
      }
    }

    /* ‚îÄ‚îÄ RUNNING ANIMATION ‚îÄ‚îÄ */
    @keyframes pulse-glow {
      0% {
        box-shadow: 0 0 14px rgba(0, 114, 255, 0.4);
      }

      50% {
        box-shadow: 0 0 28px rgba(0, 198, 255, 0.7);
      }

      100% {
        box-shadow: 0 0 14px rgba(0, 114, 255, 0.4);
      }
    }

    .run-btn.running {
      animation: pulse-glow 1s ease-in-out infinite;
    }
  </style>
</head>

<body>

  <div class="container">
    <div id="left">

      <!-- Header -->
      <div id="header-bar">
        <div class="logo-icon">‚ö°</div>
        <div class="logo-text">
          Smart House
          <span>Programmer Interface</span>
        </div>
      </div>

      <!-- House ID (hidden in Code Mode ‚Äì set via setup() inside the editor) -->
      <div id="houseIdRow" class="setup-row">
        <input id="houseIdInput" placeholder="Enter House ID‚Ä¶" oninput="setupHouse()">
        <button id="pasteBtn" onclick="pasteHouseId()" title="Paste from Clipboard">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="currentColor">
            <path
              d="M19 2h-4.18C14.4.84 13.3 0 12 0c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm7 18H5V4h2v3h10V4h2v16z" />
          </svg>
        </button>
        <button id="setBtn" onclick="setupHouse()">Set</button>
      </div>

      <!-- Mode Switcher -->
      <div class="mode-switcher" role="tablist">
        <button id="btnBlocks" class="mode-btn active" onclick="switchMode('blocks')" role="tab" aria-selected="true"
          aria-controls="blocksMode">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
            <rect x="2" y="2" width="9" height="9" rx="2" />
            <rect x="13" y="2" width="9" height="9" rx="2" />
            <rect x="2" y="13" width="9" height="9" rx="2" />
            <rect x="13" y="13" width="9" height="9" rx="2" />
          </svg>
          Blocks Mode
        </button>
        <button id="btnCode" class="mode-btn" onclick="switchMode('code')" role="tab" aria-selected="false"
          aria-controls="codeMode">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
            <path
              d="M8.293 6.293L2.586 12l5.707 5.707 1.414-1.414L5.414 12l4.293-4.293zm7.414 0l-1.414 1.414L18.586 12l-4.293 4.293 1.414 1.414L21.414 12z" />
          </svg>
          Code Mode
        </button>
      </div>

      <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BLOCKS MODE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
      <div id="blocksMode">
        <h3>Actions</h3>
        <div class="actions">
          <button onclick="addBlock('on')">Light On</button>
          <button onclick="addBlock('off')">Light Off</button>
          <button onclick="addBlock('toggle')">Toggle</button>
          <button onclick="addBlock('fan')">Fan</button>
          <button onclick="addBlock('alarm')">Alarm</button>
          <button onclick="addBlock('blinds')">Blinds</button>
          <button onclick="addBlock('thermostat')">Thermostat</button>
          <button onclick="addBlock('wait')">Wait</button>
        </div>

        <div class="ws-header">
          <h3 style="margin:0;border:none;padding:0;">Workspace</h3>
          <div style="display:flex;gap:7px;align-items:center;">
            <button id="convertBtn" onclick="convertToCode()" title="Convert blocks to JS code">‚áÑ To Code</button>
            <button id="runBtn" class="run-btn" onclick="runProgram()">
              <svg width="13" height="13" viewBox="0 0 24 24" fill="currentColor">
                <polygon points="5,3 19,12 5,21" />
              </svg>
              Run
            </button>
          </div>
        </div>
        <div id="workspace" class="workspace">
          <div class="workspace-empty" id="wsEmpty">Drop blocks here to build your program‚Ä¶</div>
        </div>
      </div>

      <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CODE MODE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
      <div id="codeMode" class="hidden">
        <h3>Available Functions</h3>
        <div class="api-pills">
          <span class="api-pill" title="Set your house ID first">setup("id")</span>
          <span class="api-pill" title="on(room)">on("living")</span>
          <span class="api-pill" title="off(room)">off("bedroom")</span>
          <span class="api-pill" title="toggle(room)">toggle("kitchen")</span>
          <span class="api-pill" title="fan(true|false)">fan(true)</span>
          <span class="api-pill" title="alarm(true|false)">alarm(false)</span>
          <span class="api-pill" title="blinds(room, 0-100)">blinds("living", 50)</span>
          <span class="api-pill" title="thermostat(mode, target)">thermostat("cooling", 65)</span>
          <span class="api-pill" title="wait(seconds)">wait(2)</span>
        </div>

        <div id="codePanel">
          <div id="monacoContainer"></div>
          <div class="code-run-row">
            <button id="codeRunBtn" class="run-btn" onclick="runCode()">
              <svg width="13" height="13" viewBox="0 0 24 24" fill="currentColor">
                <polygon points="5,3 19,12 5,21" />
              </svg>
              Run Code
            </button>
            <button class="run-btn"
              style="background:rgba(255,255,255,0.07);box-shadow:none;border:1px solid rgba(255,255,255,0.1);font-size:0.78em;padding:9px 12px;"
              onclick="clearCode()" title="Clear editor">üóë Clear</button>
          </div>
        </div>
      </div>

      <!-- Shared output terminal -->
      <div class="output-panel">
        <div class="output-header">
          <div class="output-header-left">
            <div class="output-dots">
              <div class="output-dot red"></div>
              <div class="output-dot yellow"></div>
              <div class="output-dot green"></div>
            </div>
            <span class="output-title">Output</span>
          </div>
          <button class="output-clear-btn" onclick="clearLog()">Clear</button>
        </div>
        <div id="log"></div>
      </div>
    </div>

    <!-- Right iframe simulation -->
    <div id="right">
      <iframe src="https://black-snow.onrender.com/labs/smart-house" title="Smart House Simulation"></iframe>
    </div>
  </div>

  <!-- Monaco Editor CDN -->
  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.46.0/min/vs/loader.js"></script>

  <script>
    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       CORE CONFIG & STATE
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    const BASE_URL = "https://mpinzileback.onrender.com/api/house";
    let HOUSE_ID = "";
    let program = [];
    let dragIndex = null;
    let monacoEditor = null;  // Monaco instance

    const rooms = ["living", "bedroom", "kitchen", "outdoor"];
    const blindsRooms = ["living", "bedroom"];
    const thermostatModes = ["cooling", "heating", "off"];
    const blockInputs = {
      on: ["room"], off: ["room"], toggle: ["room"],
      fan: ["state"], alarm: ["state"], door: ["state"],
      blinds: ["room", "percentage"], thermostat: ["mode", "target"], wait: ["seconds"]
    };

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       HOUSE ID SETUP
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    function setupHouse() {
      HOUSE_ID = document.getElementById("houseIdInput").value.trim();
    }

    async function pasteHouseId() {
      try {
        const text = await navigator.clipboard.readText();
        document.getElementById("houseIdInput").value = text;
        setupHouse();
        logMessage("Pasted House ID ‚úì", "info");
      } catch (e) {
        logMessage("Paste failed: " + e, "err");
      }
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       LOGGING (shared for both modes)
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    function _ts() {
      const n = new Date();
      return [n.getHours(), n.getMinutes(), n.getSeconds()]
        .map(v => String(v).padStart(2, '0')).join(':');
    }

    function logMessage(msg, type = "ok") {
      const log = document.getElementById("log");
      const row = document.createElement("div");
      row.className = "log-line";

      const ts = document.createElement("span");
      ts.className = "log-ts";
      ts.textContent = _ts();

      const text = document.createElement("span");
      text.className = type === "err" ? "log-err" : type === "info" ? "log-info" : "log-ok";
      text.textContent = msg;

      row.appendChild(ts);
      row.appendChild(text);
      log.appendChild(row);
      log.scrollTop = log.scrollHeight;
    }

    function clearLog() {
      document.getElementById("log").innerHTML = "";
    }

    // Initial ready message
    window.addEventListener('DOMContentLoaded', () => logMessage("Ready.", "info"));

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       MODE SWITCHER
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    function switchMode(mode) {
      const blocksPanel = document.getElementById("blocksMode");
      const codePanel = document.getElementById("codeMode");
      const houseIdRow = document.getElementById("houseIdRow");
      const btnBlocks = document.getElementById("btnBlocks");
      const btnCode = document.getElementById("btnCode");

      if (mode === "blocks") {
        blocksPanel.classList.remove("hidden");
        codePanel.classList.add("hidden");
        houseIdRow.classList.remove("hidden");  // show in blocks mode
        btnBlocks.classList.add("active");
        btnBlocks.setAttribute("aria-selected", "true");
        btnCode.classList.remove("active");
        btnCode.setAttribute("aria-selected", "false");
      } else {
        codePanel.classList.remove("hidden");
        blocksPanel.classList.add("hidden");
        houseIdRow.classList.add("hidden");     // hidden in code mode ‚Äì use setup()
        btnCode.classList.add("active");
        btnCode.setAttribute("aria-selected", "true");
        btnBlocks.classList.remove("active");
        btnBlocks.setAttribute("aria-selected", "false");
        // Trigger Monaco layout recalc when it becomes visible
        if (monacoEditor) setTimeout(() => monacoEditor.layout(), 50);
      }
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       BLOCKS MODE ‚Äì WORKSPACE
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    function addBlock(action) {
      const block = { action, params: {} };
      if (blockInputs[action]) blockInputs[action].forEach(p => block.params[p] = "");
      program.push(block);
      renderWorkspace();
    }

    function renderWorkspace() {
      const ws = document.getElementById("workspace");
      const empty = document.getElementById("wsEmpty");
      ws.innerHTML = "";

      if (program.length === 0) {
        ws.appendChild(empty || (() => {
          const d = document.createElement("div");
          d.className = "workspace-empty"; d.id = "wsEmpty";
          d.textContent = "Drop blocks here to build your program‚Ä¶";
          return d;
        })());
        return;
      }

      program.forEach((block, index) => {
        const div = document.createElement("div");
        div.className = "block";
        div.draggable = true;
        div.ondragstart = () => dragIndex = index;
        div.ondragover = e => { e.preventDefault(); div.classList.add("drag-over"); };
        div.ondragleave = () => div.classList.remove("drag-over");
        div.ondrop = () => { div.classList.remove("drag-over"); reorderBlocks(index); };

        const actionLabel = { on: "Light On", off: "Light Off", toggle: "Toggle", fan: "Fan", alarm: "Alarm", door: "Door", blinds: "Blinds", thermostat: "Thermostat", wait: "Wait" };
        let html = `<strong>${actionLabel[block.action] || block.action}</strong>`;

        if (["on", "off", "toggle"].includes(block.action)) {
          html += `<select onchange="updateParam(${index},'room',this.value)">
        <option value="" ${block.params.room === "" ? 'selected' : ''}>Choose room</option>
        ${rooms.map(r => `<option value="${r}" ${block.params.room === r ? 'selected' : ''}>${r}</option>`).join("")}
      </select>`;
        }
        if (["fan", "alarm"].includes(block.action)) {
          html += `<select onchange="updateParam(${index},'state',this.value)">
        <option value="" ${block.params.state === "" ? 'selected' : ''}>Choose state</option>
        <option value="on" ${block.params.state === 'on' ? 'selected' : ''}>on</option>
        <option value="off" ${block.params.state === 'off' ? 'selected' : ''}>off</option>
      </select>`;
        }
        if (block.action === "door") {
          html += `<select onchange="updateParam(${index},'state',this.value)">
        <option value="" ${block.params.state === "" ? 'selected' : ''}>Choose action</option>
        <option value="open" ${block.params.state === 'open' ? 'selected' : ''}>open</option>
        <option value="close" ${block.params.state === 'close' ? 'selected' : ''}>close</option>
      </select>`;
        }
        if (block.action === "blinds") {
          html += `<select onchange="updateParam(${index},'room',this.value)">
        <option value="" ${block.params.room === "" ? 'selected' : ''}>Choose room</option>
        ${blindsRooms.map(r => `<option value="${r}" ${block.params.room === r ? 'selected' : ''}>${r}</option>`).join("")}
      </select>`;
          const val = block.params.percentage !== "" ? block.params.percentage : 50;
          html += `<label>%:</label><input type="range" min="0" max="100" value="${val}" oninput="updateParam(${index},'percentage',this.value)"><span>${val}%</span>`;
        }
        if (block.action === "thermostat") {
          html += `<label>Mode:</label><select onchange="updateParam(${index},'mode',this.value)">
        <option value="" ${block.params.mode === "" ? 'selected' : ''}>Choose mode</option>
        ${thermostatModes.map(m => `<option value="${m}" ${block.params.mode === m ? 'selected' : ''}>${m}</option>`).join("")}
      </select>`;
          const val = block.params.target !== "" ? block.params.target : 65;
          html += `<label>Target:</label><input type="range" min="60" max="70" value="${val}" oninput="updateParam(${index},'target',this.value)"><span>${val}¬∞</span>`;
        }
        if (block.action === "wait") {
          html += `<input type="number" min="0" style="width:55px;" value="${block.params.seconds || 1}" oninput="updateParam(${index},'seconds',this.value)"> <span style="opacity:0.6;font-size:0.85em;">seconds</span>`;
        }
        html += `<button class="block-del" onclick="removeBlock(${index})">‚úï</button>`;
        div.innerHTML = html;
        ws.appendChild(div);
      });
    }

    function reorderBlocks(targetIndex) {
      if (dragIndex === null || dragIndex === targetIndex) return;
      const moved = program.splice(dragIndex, 1)[0];
      program.splice(targetIndex, 0, moved);
      dragIndex = null;
      renderWorkspace();
    }

    function updateParam(index, key, value) {
      program[index].params[key] = value;
      renderWorkspace();
    }

    function removeBlock(index) {
      program.splice(index, 1);
      renderWorkspace();
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       SHARED API CALL (both modes use this)
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    async function apiCall(action, params) {
      if (!HOUSE_ID) throw new Error("House ID not set ‚Äì please enter your House ID first.");
      const res = await fetch(BASE_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json", "X-House-Id": HOUSE_ID },
        body: JSON.stringify({ action, params })
      });
      const data = await res.json();
      return data;
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       BLOCKS MODE ‚Äì EXECUTION
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    async function executeBlock(block) {
      switch (block.action) {
        case "on": return apiCall("setLight", { room: block.params.room, on: true });
        case "off": return apiCall("setLight", { room: block.params.room, on: false });
        case "toggle": return apiCall("toggleLight", { room: block.params.room });
        case "fan": return apiCall("setFan", { on: block.params.state === 'on' });
        case "alarm": return apiCall("setAlarm", { on: block.params.state === 'on' });
        case "door": return apiCall("setLock", { open: block.params.state === 'open' });
        case "blinds": return apiCall("setBlinds", { room: block.params.room, percentage: Number(block.params.percentage) });
        case "thermostat": return apiCall("setThermostat", { mode: block.params.mode, target: Number(block.params.target) });
        case "wait": return new Promise(r => setTimeout(() => r({ waited: block.params.seconds }), Number(block.params.seconds) * 1000));
      }
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       RESULT FORMATTER ‚Äî extracts only the changed value
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    function _fmt(r, action, params) {
      if (!r || !r.success) return r ? (r.error || "error") : "no response";
      const s = r.state;
      if (!s) return "ok";
      switch (action) {
        case "setLight":    return `${params.room} light ‚Üí ${s.lights?.[params.room] ? "on" : "off"}`;
        case "toggleLight": return `${params.room} light ‚Üí ${s.lights?.[params.room] ? "on" : "off"}`;
        case "setFan":      return `fan ‚Üí ${s.fan ? "on" : "off"}`;
        case "setAlarm":    return `alarm ‚Üí ${s.alarm ? "armed" : "disarmed"}`;
        case "setLock":     return `door ‚Üí ${s.door?.open ? "open" : "closed"}`;
        case "setBlinds":   return `blinds[${params.room}] ‚Üí ${s.blinds?.[params.room]}%`;
        case "setThermostat": return `thermostat ‚Üí ${s.thermostat?.mode} / ${s.thermostat?.target}¬∞`;
        default:            return "ok";
      }
    }

    function _fmtBlock(r, block) {
      const actionMap = {
        on: "setLight",  off: "setLight", toggle: "toggleLight",
        fan: "setFan",   alarm: "setAlarm", door: "setLock",
        blinds: "setBlinds", thermostat: "setThermostat"
      };
      const params = { ...block.params, on: block.action === "on" };
      return _fmt(r, actionMap[block.action] || block.action, params);
    }

    async function runProgram() {
      if (program.length === 0) { logMessage("No blocks in workspace.", "info"); return; }
      clearLog();
      const btn = document.getElementById("runBtn");
      btn.classList.add("running"); btn.disabled = true;
      logMessage("Running program‚Ä¶", "info");
      try {
        for (let i = 0; i < program.length; i++) {
          const b = program[i];
          logMessage(`Step ${i + 1}  ${b.action}`, "info");
          const result = await executeBlock(b);
          if (result) logMessage(`  ‚úì ${_fmtBlock(result, b)}`);
        }
        logMessage("Program finished.", "ok");
      } catch (e) {
        logMessage("Error: " + (e.message || e), "err");
      }
      btn.classList.remove("running"); btn.disabled = false;
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       CODE MODE ‚Äì COMMAND QUEUE
       Functions push tasks onto _queue synchronously.
       runCode drains the queue in order after the user
       script finishes ‚Äî no "await" needed in user code.
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

    let _queue = [];
    function _enqueue(label, task) {
      logMessage(label, "info");
      _queue.push(task);
    }
    async function _drainQueue() {
      for (const task of _queue) { await task(); }
    }

    // setup(houseId) ‚Äî call this first in your code
    function setup(houseId) {
      HOUSE_ID = String(houseId).trim();
      const inp = document.getElementById("houseIdInput");
      if (inp) inp.value = HOUSE_ID;
      logMessage(`House ID ‚Üí "${HOUSE_ID}"`, "info");
    }

    // ‚îÄ‚îÄ Short-form aliases (no await needed) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function on(room)       { _enqueue(`on("${room}")`,       () => apiCall("setLight",     { room, on: true       }).then(r => logMessage(`‚úì ${_fmt(r, "setLight",     { room })}`)));}
    function off(room)      { _enqueue(`off("${room}")`,      () => apiCall("setLight",     { room, on: false      }).then(r => logMessage(`‚úì ${_fmt(r, "setLight",     { room })}`)));}
    function toggle(room)   { _enqueue(`toggle("${room}")`,   () => apiCall("toggleLight",  { room                }).then(r => logMessage(`‚úì ${_fmt(r, "toggleLight",  { room })}`)));}
    function fan(state)     { _enqueue(`fan(${state})`,        () => apiCall("setFan",       { on: Boolean(state)   }).then(r => logMessage(`‚úì ${_fmt(r, "setFan",       {})}`)));}
    function alarm(state)   { _enqueue(`alarm(${state})`,      () => apiCall("setAlarm",     { on: Boolean(state)   }).then(r => logMessage(`‚úì ${_fmt(r, "setAlarm",     {})}`)));}
    function blinds(room, pct) { _enqueue(`blinds("${room}", ${pct})`, () => apiCall("setBlinds", { room, percentage: pct }).then(r => logMessage(`‚úì ${_fmt(r, "setBlinds",   { room })}`)));}
    function thermostat(mode, target) { _enqueue(`thermostat("${mode}", ${target})`, () => apiCall("setThermostat", { mode, target }).then(r => logMessage(`‚úì ${_fmt(r, "setThermostat", { mode, target })}`)));}
    function wait(seconds)  { _enqueue(`wait(${seconds}s)`,   () => new Promise(r => setTimeout(r, seconds * 1000)));}

    // ‚îÄ‚îÄ Long-form aliases (also queue-based) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function setLight(room, isOn)        { _enqueue(`setLight("${room}", ${isOn})`,       () => apiCall("setLight",     { room, on: isOn        }).then(r => logMessage(`‚úì ${_fmt(r, "setLight",     { room })}`)));}
    function toggleLight(room)           { _enqueue(`toggleLight("${room}")`,              () => apiCall("toggleLight",  { room                  }).then(r => logMessage(`‚úì ${_fmt(r, "toggleLight",  { room })}`)));}
    function setFan(isOn)                { _enqueue(`setFan(${isOn})`,                     () => apiCall("setFan",       { on: Boolean(isOn)     }).then(r => logMessage(`‚úì ${_fmt(r, "setFan",       {})}`)));}
    function setAlarm(isOn)              { _enqueue(`setAlarm(${isOn})`,                   () => apiCall("setAlarm",     { on: Boolean(isOn)     }).then(r => logMessage(`‚úì ${_fmt(r, "setAlarm",     {})}`)));}
    function setBlinds(room, percentage) { _enqueue(`setBlinds("${room}", ${percentage})`, () => apiCall("setBlinds",    { room, percentage      }).then(r => logMessage(`‚úì ${_fmt(r, "setBlinds",   { room })}`)));}
    function setThermostat(mode, target) { _enqueue(`setThermostat("${mode}", ${target})`, () => apiCall("setThermostat",{ mode, target          }).then(r => logMessage(`‚úì ${_fmt(r, "setThermostat",{ mode, target })}`)));}


    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       CODE MODE ‚Äì RUN CODE
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    async function runCode() {
      const code = monacoEditor ? monacoEditor.getValue() : "";
      if (!code.trim()) { logMessage("Editor is empty.", "info"); return; }

      clearLog();
      _queue = [];   // reset queue before each run

      const btn = document.getElementById("codeRunBtn");
      btn.classList.add("running"); btn.disabled = true;

      try {
        // Step 1: run the user's script synchronously.
        // Each function call (on/off/fan/etc.) just registers a task on _queue.
        // No "await" needed in user code.
        const fn = new Function(`\n${code}\n`);
        fn();

        // Step 2: drain the queue ‚Äì execute tasks in order, one at a time.
        await _drainQueue();
        logMessage("Done.", "ok");
      } catch (e) {
        logMessage("Error: " + (e.message || e), "err");
        console.error(e);
      }
      btn.classList.remove("running"); btn.disabled = false;
    }

    function clearCode() {
      if (monacoEditor) monacoEditor.setValue("");
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       OPTIONAL: CONVERT BLOCKS ‚Üí CODE
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    function convertToCode() {
      if (program.length === 0) { logMessage("No blocks to convert.", "info"); return; }

      // Use current house id from input (if set) so the converted code works standalone
      const currentId = HOUSE_ID || "your-house-id";
      const header = `setup("${currentId}");\n`;

      const lines = program.map(block => {
        switch (block.action) {
          case "on":         return `on("${block.params.room || 'living'}");`;
          case "off":        return `off("${block.params.room || 'living'}");`;
          case "toggle":     return `toggle("${block.params.room || 'living'}");`;
          case "fan":        return `fan(${block.params.state === 'on'});`;
          case "alarm":      return `alarm(${block.params.state === 'on'});`;
          case "blinds":     return `blinds("${block.params.room || 'living'}", ${block.params.percentage || 50});`;
          case "thermostat": return `thermostat("${block.params.mode || 'cooling'}", ${block.params.target || 65});`;
          case "wait":       return `wait(${block.params.seconds || 1});`;
          default:           return `// Unknown: ${block.action}`;
        }
      });

      const code = header + lines.join("\n");
      if (monacoEditor) { monacoEditor.setValue(code); }
      switchMode("code");
      logMessage("‚úÖ Blocks converted to code ‚Äì switched to Code Mode.", "info");
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       MONACO EDITOR INITIALISATION
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    require.config({ paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.46.0/min/vs' } });

    require(['vs/editor/editor.main'], function () {
      // Custom dark theme matching our UI
      monaco.editor.defineTheme('smarthouse-dark', {
        base: 'vs-dark',
        inherit: true,
        rules: [
          { token: 'comment', foreground: '4a6580', fontStyle: 'italic' },
          { token: 'keyword', foreground: '00c6ff', fontStyle: 'bold' },
          { token: 'string', foreground: '7ec8a0' },
          { token: 'number', foreground: 'ffd700' },
          { token: 'identifier', foreground: 'e0e0e0' },
        ],
        colors: {
          'editor.background': '#0d1424',
          'editor.foreground': '#e0e0e0',
          'editorLineNumber.foreground': '#3a5070',
          'editorCursor.foreground': '#00c6ff',
          'editor.selectionBackground': '#1e3a5f',
          'editor.lineHighlightBackground': '#131e30',
          'editorIndentGuide.background1': '#1e2d40',
        }
      });

      monacoEditor = monaco.editor.create(document.getElementById('monacoContainer'), {
        value: [
          '// ‚îÄ‚îÄ‚îÄ Smart House Code Mode ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ',
          '// No "await" needed ‚Äî commands run in order automatically.',
          '',
          'setup("your-house-id");',
          '',
          'on("living");          // turn living room light on',
          'wait(2);               // wait 2 seconds',
          'blinds("living", 50); // set blinds to 50%',
          'fan(true);             // turn fan on',
          'off("bedroom");        // turn bedroom light off',
          'toggle("kitchen");     // toggle kitchen light',
          'alarm(false);          // disarm alarm',
          'thermostat("cooling", 65); // set thermostat',
        ].join('\n'),
        language: 'javascript',
        theme: 'smarthouse-dark',
        fontSize: 13,
        fontFamily: "'Share Tech Mono', Consolas, monospace",
        fontLigatures: true,
        minimap: { enabled: false },
        scrollBeyondLastLine: false,
        automaticLayout: true,   // auto-resize with container
        tabSize: 2,
        renderLineHighlight: 'line',
        suggest: { showKeywords: true },
        quickSuggestions: true,
        padding: { top: 12, bottom: 12 },
        lineNumbers: 'on',
        roundedSelection: true,
        smoothScrolling: true,
        cursorBlinking: 'smooth',
        cursorSmoothCaretAnimation: 'on',
      });

      // Add custom completions for our API functions (short + long names)
      monaco.languages.registerCompletionItemProvider('javascript', {
        provideCompletionItems(model, position) {
          const S = monaco.languages.CompletionItemKind.Function;
          const R = monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet;
          const suggestions = [
            // ‚îÄ‚îÄ Short aliases ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            { label: 'setup', kind: S, insertText: 'setup("${1:your-house-id}");', insertTextRules: R, documentation: 'Set your house ID (required first)' },
            { label: 'on', kind: S, insertText: 'on("${1:living}")', insertTextRules: R, documentation: 'Turn room light ON' },
            { label: 'off', kind: S, insertText: 'off("${1:living}")', insertTextRules: R, documentation: 'Turn room light OFF' },
            { label: 'toggle', kind: S, insertText: 'toggle("${1:living}")', insertTextRules: R, documentation: 'Toggle room light' },
            { label: 'fan', kind: S, insertText: 'fan(${1:true})', insertTextRules: R, documentation: 'Turn fan on (true) or off (false)' },
            { label: 'alarm', kind: S, insertText: 'alarm(${1:true})', insertTextRules: R, documentation: 'Arm (true) or disarm (false) alarm' },
            { label: 'blinds', kind: S, insertText: 'blinds("${1:living}", ${2:50})', insertTextRules: R, documentation: 'Set blinds 0-100%' },
            { label: 'thermostat', kind: S, insertText: 'thermostat("${1:cooling}", ${2:65})', insertTextRules: R, documentation: 'Set thermostat mode and target temp' },
            { label: 'wait', kind: S, insertText: 'wait(${1:2})', insertTextRules: R, documentation: 'Wait N seconds' },
            // ‚îÄ‚îÄ Long aliases ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            { label: 'setLight', kind: S, insertText: 'setLight("${1:living}", ${2:true})', insertTextRules: R, documentation: 'Turn a room light on/off' },
            { label: 'toggleLight', kind: S, insertText: 'toggleLight("${1:living}")', insertTextRules: R, documentation: 'Toggle a room light' },
            { label: 'setFan', kind: S, insertText: 'setFan(${1:true})', insertTextRules: R, documentation: 'Turn the fan on/off' },
            { label: 'setAlarm', kind: S, insertText: 'setAlarm(${1:true})', insertTextRules: R, documentation: 'Arm/disarm the alarm' },
            { label: 'setBlinds', kind: S, insertText: 'setBlinds("${1:living}", ${2:50})', insertTextRules: R, documentation: 'Set blinds position (0-100)' },
            { label: 'setThermostat', kind: S, insertText: 'setThermostat("${1:cooling}", ${2:65})', insertTextRules: R, documentation: 'Set thermostat mode and target' },
          ];
          return { suggestions };
        }
      });

      // Cmd/Ctrl+Enter to run code
      monacoEditor.addCommand(
        monaco.KeyMod.CtrlCmd | monaco.KeyCode.Enter,
        () => runCode()
      );
    });
  </script>

</body>

</html>